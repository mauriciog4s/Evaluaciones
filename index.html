<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portal Evaluaciones G4S</title>
  <link rel="icon" href="https://www.g4s.com/favicon.ico">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --g4s-red: #c1272d; --g4s-black: #231f20; --side-w: 260px; }
    body { background-color: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; }

    #system-loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
    
    #sidebar { width: var(--side-w); height: 100vh; position: fixed; left: 0; top: 0; background: white; border-right: 1px solid #e2e8f0; z-index: 1000; transition: transform 0.3s ease; }
    #main-wrapper { margin-left: var(--side-w); padding: 30px; transition: margin-left 0.3s ease; }

    @media (max-width: 768px) { 
      #sidebar { transform: translateX(-100%); } 
      #sidebar.open { transform: translateX(0); box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
      #main-wrapper { margin-left: 0; padding: 20px; padding-top: 80px; }
      #mobile-header { display: flex !important; }
    }

    .nav-item { padding: 12px 24px; display: flex; align-items: center; color: #64748b; cursor: pointer; border-left: 4px solid transparent; font-size: 14px; transition: 0.2s; font-weight: 500; }
    .nav-item:hover { background: #f8fafc; color: var(--g4s-black); }
    .nav-item.active { background: #fff1f2; color: var(--g4s-red); border-left-color: var(--g4s-red); font-weight: bold; }
    
    .card-stat { background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
    .g4s-btn { background-color: var(--g4s-red); color: white; border-radius: 8px; font-weight: bold; transition: 0.2s; }
    .g4s-btn:hover { background-color: #a01b20; transform: translateY(-1px); }

    .hidden { display: none !important; }
    
    .skeleton-box { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body onload="initApp()">

  <div id="system-loader">
    <div class="w-12 h-12 border-4 border-gray-100 border-t-[#c1272d] rounded-full animate-spin mb-4"></div>
    <div class="text-[10px] font-bold tracking-[0.4em] text-gray-400 uppercase animate-pulse">Cargando G4S...</div>
  </div>

  <header id="mobile-header" class="fixed top-0 left-0 right-0 h-16 bg-white border-b z-[500] px-4 hidden items-center justify-between">
      <img src="https://www.g4s.com/es-co/-/media/g4s/global/images/logos/g4s---an-allied-universal-company-logo/g4s_one-company_logo_180x136.ashx" class="h-8">
      <button onclick="toggleMenu()" class="p-2 text-gray-600"><span class="material-icons">menu</span></button>
  </header>

  <aside id="sidebar">
    <div class="p-8 flex justify-center border-b border-gray-100">
      <img src="https://www.g4s.com/es-co/-/media/g4s/global/images/logos/g4s---an-allied-universal-company-logo/g4s_one-company_logo_180x136.ashx" class="h-10">
    </div>
    <nav class="mt-6 space-y-1">
      <div onclick="nav('inicio')" class="nav-item active" id="m-inicio"><span class="material-icons mr-3">dashboard</span> Inicio</div>
      <div onclick="nav('evaluar')" class="nav-item" id="m-evaluar"><span class="material-icons mr-3">assignment_ind</span> Evaluar Talento</div>
      <div onclick="nav('mis-evaluaciones')" class="nav-item" id="m-mis-evaluaciones"><span class="material-icons mr-3">history</span> Mis Evaluaciones</div>
      
      <div id="admin-menu" class="hidden border-t border-gray-100 mt-4 pt-4">
        <p class="px-6 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Administración</p>
        <div onclick="nav('usuarios')" class="nav-item" id="m-usuarios"><span class="material-icons mr-3">people</span> Usuarios</div>
        <div onclick="nav('formulario')" class="nav-item" id="m-formulario"><span class="material-icons mr-3">edit_note</span> Formulario</div>
        <div onclick="nav('plantilla')" class="nav-item" id="m-plantilla"><span class="material-icons mr-3">description</span> Plantilla</div>
      </div>
    </nav>
    <div class="absolute bottom-0 w-full p-6 border-t bg-gray-50">
      <p id="user-email-display" class="text-[10px] text-gray-500 font-bold mb-1 truncate">Cargando...</p>
      <span id="user-role-display" class="inline-block px-2 py-0.5 rounded bg-gray-100 text-[9px] font-black uppercase text-gray-600 mb-3 tracking-wide border border-gray-200">...</span>
      <button onclick="logout()" class="text-[10px] font-bold text-red-600 uppercase flex items-center hover:text-red-800 tracking-widest"><span class="material-icons text-sm mr-1">logout</span> Cerrar Sesión</button>
    </div>
  </aside>

  <div id="main-wrapper">
    
    <!-- 1. INICIO -->
    <section id="sec-inicio" class="animate__animated animate__fadeIn">
      <h2 class="text-2xl font-black text-slate-800 mb-6">PANEL DE CONTROL</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card-stat border-l-4 border-gray-800"><p class="text-[10px] font-bold text-gray-400 uppercase">Total</p><h3 id="stat-total" class="text-3xl font-black text-slate-800 mt-2">0</h3></div>
        <div class="card-stat border-l-4 border-green-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Excelentes</p><h3 id="stat-exc" class="text-3xl font-black text-green-600 mt-2">0</h3></div>
        <div class="card-stat border-l-4 border-blue-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Buenos</p><h3 id="stat-buenos" class="text-3xl font-black text-blue-600 mt-2">0</h3></div>
        <div class="card-stat border-l-4 border-red-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Deficientes</p><h3 id="stat-def" class="text-3xl font-black text-red-600 mt-2">0</h3></div>
      </div>
    </section>

    <!-- 2. EVALUAR -->
    <section id="sec-evaluar" class="hidden">
      <div class="max-w-2xl mx-auto mt-10">
        <h2 class="text-2xl font-black text-center mb-8">EVALUAR TALENTO</h2>
        <div id="search-box" class="bg-white p-2 rounded-2xl shadow-xl border flex items-center gap-3">
          <span class="material-icons text-gray-400 ml-4">search</span>
          <input type="number" id="input-cedula" class="w-full p-3 bg-transparent outline-none text-lg font-bold placeholder-gray-300" placeholder="Número de Cédula">
          <button onclick="buscarEmpleado()" id="btn-buscar" class="bg-[#231f20] text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition flex items-center gap-2">BUSCAR</button>
        </div>
        <div id="result-card" class="hidden mt-8 bg-white rounded-3xl shadow-2xl overflow-hidden border">
           <div class="bg-[#231f20] p-6 text-white relative">
             <span class="bg-white/20 px-2 py-1 rounded text-[10px] font-bold uppercase">Colaborador</span>
             <h2 id="card-nombre" class="text-xl font-black mt-2">Nombre</h2>
             <p id="card-cargo" class="text-red-400 text-xs font-bold uppercase mt-1">Cargo</p>
           </div>
           <div class="p-6">
             <div class="grid grid-cols-2 gap-4 mb-6">
               <div class="bg-gray-50 p-3 rounded-xl"><small class="text-gray-400 font-bold uppercase block text-[10px]">Cédula</small><span id="card-cedula" class="font-bold text-sm">-</span></div>
               <div class="bg-gray-50 p-3 rounded-xl"><small class="text-gray-400 font-bold uppercase block text-[10px]">Sucursal</small><span id="card-sucursal" class="font-bold text-sm">-</span></div>
             </div>
             <button onclick="abrirFormulario()" class="w-full py-4 bg-[#c1272d] text-white rounded-xl font-bold uppercase shadow-lg hover:bg-[#a01b20] flex justify-center gap-2"><span>Iniciar Formulario</span> <span class="material-icons text-sm">open_in_new</span></button>
           </div>
           <div class="text-center pb-6"><button onclick="resetSearch()" class="text-xs text-gray-400 font-bold hover:text-black">NUEVA BÚSQUEDA</button></div>
        </div>
      </div>
    </section>

    <!-- 3. REPORTES -->
    <section id="sec-mis-evaluaciones" class="hidden">
      <h2 class="text-2xl font-black mb-6 uppercase">Mis Evaluaciones</h2>
      <div class="bg-white p-4 rounded-xl border mb-6 flex gap-4 flex-wrap">
        <input type="date" id="report-start" class="border p-2 rounded-lg text-sm">
        <input type="date" id="report-end" class="border p-2 rounded-lg text-sm">
        <button onclick="cargarReportes()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase">Filtrar</button>
        <button onclick="descargarCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase flex items-center gap-2"><span class="material-icons text-sm">download</span> CSV</button>
      </div>
      <div class="bg-white rounded-xl border overflow-hidden">
        <table class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-500 font-bold text-xs uppercase"><tr><th class="p-4">Fecha</th><th class="p-4">Evaluado</th><th class="p-4">Resultado</th><th class="p-4">PDF</th></tr></thead><tbody id="report-body" class="divide-y"><tr><td colspan="4" class="p-8 text-center text-gray-400 italic">Seleccione fechas</td></tr></tbody></table>
      </div>
    </section>

    <!-- 4. USUARIOS -->
    <section id="sec-usuarios" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-black uppercase">Gestión Usuarios</h2>
        <button onclick="modalUsuario('CREATE')" class="bg-[#c1272d] text-white px-4 py-2 rounded-lg text-xs font-bold uppercase flex items-center gap-2"><span class="material-icons text-sm">add</span> Nuevo</button>
      </div>
      <div class="bg-white rounded-xl border overflow-hidden">
        <table class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-500 font-bold text-xs uppercase"><tr><th class="p-4">Nombre</th><th class="p-4">Correo</th><th class="p-4">Rol</th><th class="p-4">Estado</th><th class="p-4">Acción</th></tr></thead><tbody id="users-body" class="divide-y"></tbody></table>
      </div>
    </section>

    <!-- 5. FORMULARIO -->
    <section id="sec-formulario" class="hidden">
      <h2 class="text-2xl font-black mb-6 uppercase">Editor de Preguntas</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-4" id="questions-list"></div>
        <div class="bg-white p-6 rounded-xl border h-fit sticky top-4">
           <h3 class="font-bold mb-4">Acciones</h3>
           <button onclick="addQuestion()" class="w-full py-3 bg-slate-800 text-white rounded-lg font-bold text-sm mb-4">Agregar Pregunta</button>
        </div>
      </div>
    </section>

    <!-- 6. PLANTILLA (NUEVO) -->
    <section id="sec-plantilla" class="hidden">
      <h2 class="text-2xl font-black mb-6 uppercase">Gestión de Plantilla</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- Tarjeta Principal -->
        <div class="md:col-span-2 bg-white rounded-2xl shadow-lg border overflow-hidden">
          <div class="bg-blue-600 p-6 text-white flex justify-between items-center">
            <div>
              <h3 class="font-black text-xl uppercase">Plantilla Oficial</h3>
              <p class="text-blue-100 text-sm mt-1">Google Docs - PDF Generator</p>
            </div>
            <span class="material-icons text-4xl opacity-50">description</span>
          </div>
          <div class="p-8 text-center">
            <p class="text-gray-600 mb-6 max-w-md mx-auto">Esta plantilla se utiliza para generar automáticamente los PDFs que se envían por correo. Puede editar el diseño, logos y textos fijos directamente en Google Docs.</p>
            
            <button onclick="abrirPlantillaDocs()" class="bg-[#c1272d] text-white px-8 py-4 rounded-xl font-bold uppercase shadow-xl hover:bg-[#a01b20] transition transform hover:-translate-y-1 flex items-center justify-center gap-3 mx-auto">
              <span class="material-icons">edit_document</span>
              Editar Plantilla en Google Docs
            </button>
          </div>
        </div>

        <!-- Guía de Variables -->
        <div class="bg-white p-6 rounded-2xl border shadow-sm h-fit">
          <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><span class="material-icons text-yellow-500 text-sm">warning</span> Variables del Sistema</h4>
          <p class="text-xs text-gray-500 mb-4 text-justify">
            Al editar el documento, <strong>NO modifique ni borre</strong> los siguientes códigos entre llaves dobles <code>{{ }}</code>, ya que son reemplazados automáticamente por los datos reales.
          </p>
          <div class="bg-gray-50 p-3 rounded-lg border text-xs font-mono space-y-2 max-h-96 overflow-y-auto">
            <div class="flex justify-between border-b pb-1"><span class="text-blue-600">{{NOMBRE_EVALUADO}}</span></div>
            <div class="flex justify-between border-b pb-1"><span class="text-blue-600">{{CEDULA}}</span></div>
            <div class="flex justify-between border-b pb-1"><span class="text-blue-600">{{CARGO}}</span></div>
            <div class="flex justify-between border-b pb-1"><span class="text-blue-600">{{SUCURSAL}}</span></div>
            <div class="flex justify-between border-b pb-1"><span class="text-blue-600">{{FECHA_INGRESO}}</span></div>
            <div class="flex justify-between border-b pb-1"><span class="text-purple-600">{{NOMBRE_EVALUADOR}}</span></div>
            <div class="flex justify-between border-b pb-1"><span class="text-purple-600">{{CARGO_EVALUADOR}}</span></div>
            <div class="flex justify-between border-b pb-1"><span class="text-green-600">{{EVALUACION_GLOBAL}}</span></div>
            <div class="flex justify-between border-b pb-1"><span class="text-green-600">{{COMPROMISOS}}</span></div>
            <div class="flex justify-between border-b pb-1"><span class="text-green-600">{{CONCEPTO_JEFE}}</span></div>
            <div class="flex justify-between border-b pb-1"><span class="text-gray-500">{{FECHA_EVALUACION}}</span></div>
            <div class="mt-2 text-gray-400 italic text-[10px]">Preguntas: {{P1}} ... {{P20}}</div>
          </div>
        </div>

      </div>
    </section>

  </div>

  <!-- MODAL USUARIO -->
  <div id="modal-user" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[2000] flex">
     <div class="bg-white p-6 rounded-2xl w-96 shadow-2xl">
        <h3 class="font-black text-lg mb-4 uppercase">Usuario</h3>
        <form id="form-user" onsubmit="saveUser(event)" class="space-y-3">
           <input type="hidden" id="u-action"><input type="hidden" id="u-row">
           <input id="u-nombre" placeholder="Nombre" class="w-full border p-2 rounded outline-none" required>
           <input id="u-correo" placeholder="Correo Google" class="w-full border p-2 rounded outline-none" required>
           <div class="grid grid-cols-2 gap-2">
             <select id="u-rol" class="w-full border p-2 rounded outline-none bg-white"><option>Administrador</option><option>Evaluador</option><option>Usuario</option></select>
             <select id="u-estado" class="w-full border p-2 rounded outline-none bg-white"><option>Activo</option><option>Inactivo</option></select>
           </div>
           <div class="flex gap-2 pt-4"><button type="button" onclick="document.getElementById('modal-user').classList.add('hidden')" class="flex-1 py-2 text-gray-500 font-bold text-xs uppercase hover:bg-gray-100 rounded">Cancelar</button><button type="submit" class="flex-1 py-2 bg-red-600 text-white rounded font-bold text-xs uppercase hover:bg-red-700">Guardar</button></div>
        </form>
     </div>
  </div>

  <!-- MODAL FORMULARIO EMBEBIDO -->
  <div id="modal-form-embed" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[3000] p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-full max-w-5xl h-[90vh] flex flex-col shadow-2xl overflow-hidden relative">
        <div class="bg-white p-4 border-b flex justify-between items-center shadow-sm z-20">
            <h3 class="font-black text-slate-800 uppercase tracking-tight flex items-center gap-2"><span class="material-icons text-red-600">assignment</span> Evaluación</h3>
            <button onclick="closeFormModal()" class="bg-gray-100 hover:bg-red-50 text-gray-500 hover:text-red-600 p-2 rounded-full transition-colors"><span class="material-icons">close</span></button>
        </div>
        <div class="flex-grow overflow-hidden relative bg-gray-50">
             <div id="form-loader" class="absolute inset-0 flex items-center justify-center z-10 bg-white">
                <div class="flex flex-col items-center"><div class="w-10 h-10 border-4 border-gray-100 border-t-[#c1272d] rounded-full animate-spin mb-2"></div><span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Cargando Formulario...</span></div>
             </div>
             <iframe id="gform-frame" src="" class="w-full h-full border-0" onload="document.getElementById('form-loader').classList.add('hidden')"></iframe>
        </div>
    </div>
  </div>

  <script>
    let appData = {};
    let currentEmployee = null;
    let usersList = [];
    let reportData = [];

    const skeletonUserRow = `<tr class="animate-pulse border-b"><td class="p-4"><div class="h-4 bg-gray-200 rounded w-3/4 skeleton-box"></div></td><td class="p-4"><div class="h-4 bg-gray-200 rounded w-1/2 skeleton-box"></div></td><td class="p-4"><div class="h-4 bg-gray-200 rounded w-1/4 skeleton-box"></div></td><td class="p-4"><div class="h-6 bg-gray-200 rounded-full w-16 skeleton-box"></div></td><td class="p-4"><div class="h-4 bg-gray-200 rounded w-8 skeleton-box"></div></td></tr>`;
    const skeletonQuestionCard = `<div class="bg-white p-4 rounded-xl border shadow-sm animate-pulse flex justify-between items-center"><div class="h-4 bg-gray-200 rounded w-2/3 skeleton-box"></div><div class="flex gap-2"><div class="w-8 h-8 bg-gray-200 rounded skeleton-box"></div><div class="w-8 h-8 bg-gray-200 rounded skeleton-box"></div></div></div>`;

    function initApp() {
      google.script.run
        .withSuccessHandler(data => {
           if(data.error) return Swal.fire('Error', data.message, 'error');
           appData = data;
           document.getElementById('system-loader').classList.add('hidden');
           document.getElementById('user-email-display').innerText = data.email;
           document.getElementById('user-role-display').innerText = data.role;
           
           document.getElementById('stat-total').innerText = data.dashboard.total;
           document.getElementById('stat-exc').innerText = data.dashboard.excelentes;
           document.getElementById('stat-buenos').innerText = data.dashboard.buenos;
           document.getElementById('stat-def').innerText = data.dashboard.deficientes;

           if(data.isAdmin) document.getElementById('admin-menu').classList.remove('hidden');
           // Ocultar modal user al inicio por si acaso
           document.getElementById('modal-user').classList.add('hidden');
        })
        .withFailureHandler(err => Swal.fire('Error', 'Recargue la página', 'error'))
        .getInitData();
    }

    function nav(id) {
      document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
      document.getElementById('sec-' + id).classList.remove('hidden');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('m-' + id).classList.add('active');
      if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');

      if(id === 'usuarios') loadUsers();
      if(id === 'formulario') loadQuestions();
    }

    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }
    function logout() { window.open('https://accounts.google.com/Logout', '_blank'); location.reload(); }

    function buscarEmpleado() {
      const cedula = document.getElementById('input-cedula').value;
      if(!cedula) return;
      const btn = document.getElementById('btn-buscar'); 
      const originalText = btn.innerText;
      btn.innerHTML = '<span class="material-icons animate-spin text-sm mr-2">sync</span> Buscando...';
      btn.disabled = true;
      btn.classList.add('opacity-75', 'cursor-not-allowed');

      google.script.run.withSuccessHandler(res => {
         btn.innerHTML = originalText;
         btn.disabled = false;
         btn.classList.remove('opacity-75', 'cursor-not-allowed');
         if(!res.found) return Swal.fire('No encontrado', 'Cédula no existe', 'warning');
         currentEmployee = res.data;
         document.getElementById('card-nombre').innerText = res.data.nombre;
         document.getElementById('card-cargo').innerText = res.data.cargo;
         document.getElementById('card-cedula').innerText = res.data.cedula;
         document.getElementById('card-sucursal').innerText = res.data.sucursal;
         document.getElementById('search-box').classList.add('hidden');
         document.getElementById('result-card').classList.remove('hidden');
      }).buscarEmpleado(cedula);
    }

    function resetSearch() {
      currentEmployee = null;
      document.getElementById('result-card').classList.add('hidden');
      document.getElementById('search-box').classList.remove('hidden');
      document.getElementById('input-cedula').value = '';
    }

    function abrirFormulario() {
      if(!currentEmployee) return;
      let url = appData.formUrlBase
        .replace('{{NOMBRE}}', encodeURIComponent(currentEmployee.nombre))
        .replace('{{CEDULA}}', encodeURIComponent(currentEmployee.cedula))
        .replace('{{CARGO}}', encodeURIComponent(currentEmployee.cargo))
        .replace('{{EMAIL}}', encodeURIComponent(currentEmployee.email));
      if(!url.includes('embedded=true')) url += '&embedded=true';
      
      const modal = document.getElementById('modal-form-embed');
      const iframe = document.getElementById('gform-frame');
      const loader = document.getElementById('form-loader');
      iframe.src = url;
      loader.classList.remove('hidden'); 
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeFormModal() {
        const modal = document.getElementById('modal-form-embed');
        const iframe = document.getElementById('gform-frame');
        modal.classList.add('hidden'); modal.classList.remove('flex');
        setTimeout(() => { iframe.src = 'about:blank'; }, 300);
    }

    function cargarReportes() {
      const i = document.getElementById('report-start').value;
      const f = document.getElementById('report-end').value;
      if(!i || !f) return Swal.fire('Fechas', 'Seleccione rango', 'info');
      document.getElementById('report-body').innerHTML = '<tr><td colspan="4" class="p-8 text-center"><div class="flex justify-center"><div class="w-8 h-8 border-4 border-gray-100 border-t-red-600 rounded-full animate-spin"></div></div></td></tr>';
      google.script.run.withSuccessHandler(rows => {
         reportData = rows;
         const html = rows.map(r => `<tr class="hover:bg-gray-50 transition"><td class="p-4 text-gray-600">${r.fecha}</td><td class="p-4 font-bold">${r.nombre}</td><td class="p-4"><span class="px-2 py-1 rounded bg-gray-100 text-xs font-bold">${r.resultado}</span></td><td class="p-4"><a href="${r.link}" target="_blank" class="text-red-600 font-bold text-xs uppercase hover:underline">Ver PDF</a></td></tr>`).join('');
         document.getElementById('report-body').innerHTML = html || '<tr><td colspan="4" class="p-4 text-center">Sin resultados</td></tr>';
      }).getReportData(i, f);
    }

    function descargarCSV() {
      if(!reportData.length) return;
      let csv = "FECHA,NOMBRE,CEDULA,RESULTADO,PDF\n";
      reportData.forEach(r => csv += `${r.fecha},${r.nombre},${r.cedula},${r.resultado},${r.link}\n`);
      const blob = new Blob([csv], {type:'text/csv'});
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'reporte.csv'; a.click();
    }

    function loadUsers() {
      document.getElementById('users-body').innerHTML = skeletonUserRow.repeat(5);
      google.script.run.withSuccessHandler(users => {
         usersList = users;
         const html = users.map(u => `<tr class="border-b hover:bg-gray-50 transition"><td class="p-4 font-bold">${u.nombre}</td><td class="p-4 text-xs text-gray-500">${u.correo}</td><td class="p-4 text-xs">${u.rol}</td><td class="p-4"><span class="px-2 py-1 rounded-full text-[10px] font-bold ${u.estado === 'Activo' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">${u.estado}</span></td><td class="p-4"><button onclick="editUser(${u.row})" class="text-blue-600"><span class="material-icons text-sm">edit</span></button><button onclick="deleteUser(${u.row})" class="text-red-600 ml-2"><span class="material-icons text-sm">delete</span></button></td></tr>`).join('');
         document.getElementById('users-body').innerHTML = html;
      }).getUsersData();
    }

    function modalUsuario(action, row = null) {
      document.getElementById('modal-user').classList.remove('hidden');
      document.getElementById('u-action').value = action;
      document.getElementById('u-row').value = row || '';
      document.getElementById('form-user').reset();
      if(action === 'UPDATE' && row) {
        const u = usersList.find(x => x.row === row);
        if(u) {
          document.getElementById('u-nombre').value = u.nombre;
          document.getElementById('u-correo').value = u.correo;
          document.getElementById('u-rol').value = u.rol;
          document.getElementById('u-estado').value = u.estado;
        }
      }
    }
    
    function editUser(row) { modalUsuario('UPDATE', row); }

    function saveUser(e) {
      e.preventDefault();
      const data = {
        row: document.getElementById('u-row').value,
        nombre: document.getElementById('u-nombre').value,
        correo: document.getElementById('u-correo').value,
        rol: document.getElementById('u-rol').value,
        estado: document.getElementById('u-estado').value
      };
      const action = document.getElementById('u-action').value;
      google.script.run.withSuccessHandler(() => {
        document.getElementById('modal-user').classList.add('hidden');
        loadUsers();
        Swal.fire('Guardado', '', 'success');
      }).saveUser(action, data);
    }

    function deleteUser(row) {
      Swal.fire({title:'¿Eliminar?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'}).then(r => {
        if(r.isConfirmed) google.script.run.withSuccessHandler(loadUsers).saveUser('DELETE', {row: row});
      });
    }

    function loadQuestions() {
      document.getElementById('questions-list').innerHTML = skeletonQuestionCard.repeat(4);
      google.script.run.withSuccessHandler(list => {
         const html = list.map(q => `<div class="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm hover:shadow-md transition"><div><span class="font-bold text-gray-800 text-sm">${q.title}</span></div><div class="flex gap-2"><button onclick="editQuestion('${q.id}', '${q.title}')" class="p-2 bg-gray-100 rounded hover:bg-gray-200"><span class="material-icons text-sm text-gray-600">edit</span></button><button onclick="delQuestion('${q.id}')" class="p-2 bg-red-50 rounded hover:bg-red-100"><span class="material-icons text-sm text-red-600">delete</span></button></div></div>`).join('');
         document.getElementById('questions-list').innerHTML = html || '<p class="text-center text-gray-400">No se encontraron preguntas editables.</p>';
      }).getFormStructure();
    }

    function addQuestion() {
      Swal.fire({ title: 'Nueva Pregunta', input: 'text', inputLabel: 'Texto de la pregunta', showCancelButton: true, confirmButtonColor: '#231f20' }).then(r => {
        if(r.isConfirmed && r.value) google.script.run.withSuccessHandler(loadQuestions).modifyFormQuestion('ADD', {title: r.value});
      });
    }

    function delQuestion(id) {
       Swal.fire({title:'¿Eliminar pregunta?', text:'Esto no se puede deshacer', icon:'warning', showCancelButton:true}).then(r => {
         if(r.isConfirmed) google.script.run.withSuccessHandler(loadQuestions).modifyFormQuestion('DELETE', {id: id});
       });
    }

    function editQuestion(id, currentTitle) {
      Swal.fire({ title: 'Editar Pregunta', input: 'text', inputValue: currentTitle, showCancelButton: true, confirmButtonColor: '#231f20' }).then(r => {
        if(r.isConfirmed && r.value) google.script.run.withSuccessHandler(loadQuestions).modifyFormQuestion('UPDATE', {id: id, title: r.value});
      });
    }

    // --- NUEVA FUNCIÓN: ABRIR PLANTILLA ---
    function abrirPlantillaDocs() {
      if(appData && appData.templateUrl) {
        window.open(appData.templateUrl, '_blank');
      } else {
        Swal.fire('Error', 'No se ha configurado la URL de la plantilla', 'error');
      }
    }
  </script>
</body>
</html>
